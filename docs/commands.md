# 命令记录

| 日期 | 命令 |
|------|------|
| 2026-02-25 | CLAUDE.md 增加规则：将用户发起的每一条命令记录到 docs/commands.md |
| 2026-02-25 | 讨论 stage1.md 方案：IDataFrame 默认实现效率问题，要求提供高性能方案 |
| 2026-02-25 | 讨论 stage1.md：IDataFrame 默认实现效率问题，列举高效方案供选择 |
- 2026-02-25: 头文件防止重复包含的宏定义全部调整为 _FLOWSQL_当前目录_文件名_H_ 格式
- 2026-02-25: Stage 1 设计变更：DataFrame 改用 Arrow RecordBatch 存储，通信协议改为 REST + Arrow IPC
- 2026-02-25: 实现 Stage 1 全部代码
- 2026-02-25: 第三方依赖构建隔离：将 thirdparts 编译产物移到 build 目录外，避免每次清理重建
- 2026-02-25: 将 .thirdparts_installed 和 .thirdparts_prefix 加到 .gitignore
- 2026-02-25: 列举 stage1 已实现的能力
- 2026-02-25: 更新 docs/stage1.md 实施清单，标记已完成项
- 2026-02-25: 分析 docs/stage2.md 设计方案
- 2026-02-25: 更新 docs/stage2.md，新增模块 P（插件系统增强：三阶段加载 + 动态注册/注销）
- 2026-02-25: 更新 docs/stage2.md，PluginRegistry 重构为通用 IID 动态注册接口
- 2026-02-25: 提交上传代码（新增 stage2.md 设计文档）
- 2026-02-26: 清理 src/common/ 下 28 个未引用的头文件和源文件（死代码删除）
- 2026-02-26: 修复 test_npi 引用旧库名 libfast_npi2.0.so 的问题，改为 libflowsql_npi.so，并添加空指针防御
- 2026-02-26: CLAUDE.md 添加编程规则：尽量使用成熟的开源方案，不重复造轮子
- 2026-02-26: 安装 gh CLI (GitHub CLI) v2.87.3
- 2026-02-26: 更新 CLAUDE.md 架构章节，使其与实际代码一致
- 2026-02-26: 聚焦模块 P 分析问题和改进方案（7 个问题：Start 回滚、fntraverse 限制、类型安全、悬空指针、多 IPlugin Load、单例、继承链）
- 2026-02-26: 实现模块 P（插件系统增强）：loader.hpp 三阶段加载 + Start 回滚 + Unload 清理；PluginRegistry 单例 + 双层索引 + 动态注册/注销 + 统一 Traverse；适配 Service 和 test_framework + 新增动态注册测试
- 2026-02-26: 整理核心接口说明（IPlugin/IModule/IChannel/IOperator/IDataFrame/IDataEntity），写入 docs/stage2.md 架构章节和 README.md
- 2026-02-26: 实现模块 A（C++ ↔ Python 桥接）：ArrowIpcSerializer、PythonOperatorBridge、PythonProcessManager、BridgePlugin（C++ 端）；FastAPI Worker、OperatorBase 装饰器注册、OperatorRegistry 自动发现（Python 端）；httplib 第三方依赖；test_bridge 测试；修复 DataFrame::Finalize() 中 InitBuilders() 覆盖 batch_ 的 bug
- 2026-02-27: 讨论模块 B（Web 管理系统）需求分解：缩减范围聚焦 Python 算子执行链路；IChannel 重构（基类只保留生命周期+身份+元数据，数据读写下沉子类，dynamic_cast）；IDataEntity 转为元数据声明角色；Pipeline 单算子执行模型；SQL 语法设计（SELECT...FROM...USING...WITH...INTO）；DataFrameChannel 设计；更新 stage2.md
- 2026-02-27: 设计修正：Python算子输入/输出通道不限于DataFrame，新增IDatabaseChannel接口设计（IBatchReader/IBatchWriter工厂模式，Arrow IPC交换格式）；新增存储算子(system.store)和提取算子(system.extract)概念，格式转换职责交给算子而非通道；WITH子句承载写入配置（参考Spark/Flink SQL模式）；更新stage2.md
- 2026-02-27: 设计共识：IOperator::Work 签名从 Work(IDataFrame*, IDataFrame*) 改为 Work(IChannel*, IChannel*)，算子内部自行 dynamic_cast 到所需通道子类型并完成数据读写；Pipeline 简化为纯连接器，不参与数据读写；更新 stage2.md（IOperator 描述、数据流通路径、Pipeline 架构、存储/提取算子工作流、PythonOperatorBridge、实施步骤）
- 2026-02-27: 全文审视 stage2.md 自洽性，修正5处问题：(1)核心接口体系IChannel描述同步为新版（移除Put/Get）；(2)设计理由中"Pipeline做dynamic_cast"改为"算子做"；(3)存储/提取算子明确本阶段只实现框架骨架；(4)关键文件清单补充ioperator.h和python_operator_bridge；(5)Pipeline执行流程补充省略INTO时创建临时DataFrameChannel作为sink
- 2026-02-27: 验收视角审视 stage2.md，修正4处：(1)验证方案中test_framework/test_bridge标注需适配新接口；(2)新增端到端验收场景（具体SQL+期望结果）；(3)新增flowsql_web启动序列描述；(4)新增预填测试数据Schema定义
- 2026-02-27: 补充2处验收细节：(1)DataFrameChannel Read()快照语义/Write()替换语义；(2)新增验收场景2——Python算子上传激活完整链路
- 2026-02-27: 实现步骤3（IChannel重构+IOperator接口调整）：ichannel.h移除Put/Get新增Type/Schema（返回const char*）；ioperator.h Work签名改为Work(IChannel*,IChannel*)；新建idataframe_channel.h（IDataFrameChannel子接口）和idatabase_channel.h（IDatabaseChannel+IBatchReader/IBatchWriter仅接口）；新建DataFrameChannel内存实现（快照Read/替换Write）；适配MemoryChannel→IDataFrameChannel、PassthroughOperator和PythonOperatorBridge→Work(IChannel*,IChannel*)+dynamic_cast；Pipeline简化为纯连接器；更新test_framework新增DataFrameChannel测试；全部编译通过+测试通过
- 2026-02-27: 实现步骤4-6（SQL解析器+SQLite数据库层+Web后端API）：SQL递归下降解析器；SQLite amalgamation依赖+Database封装+参数化查询；Web后端全部API端点实现并测试通过；代码审查修复3个问题（路径穿越防护、mkdir冲突、JSON安全构造）
- 2026-02-27: 更新 stage2.md 进度：步骤3-6标记为已完成，更新已完成文件清单和需修改/新建文件状态
- 2026-02-27: DataFrameChannel Read/Write 效率优化：逐行复制改为 Arrow RecordBatch 零拷贝传递，Schema() 改为 Write 时缓存
- 2026-02-27: 提交推送模块 B 全部代码（IChannel重构+SQL解析+Web后端+DataFrameChannel零拷贝优化）
- 2026-02-28: 实现步骤7（Vue.js前端开发）：初始化Vue3+Vite项目；安装vue-router/axios/element-plus依赖；实现Dashboard/Channels/Operators/Tasks四个页面；API封装适配后端数组格式；构建部署到web/static/；测试验证前后端集成
- 2026-02-28: 修复任务历史显示问题：字段名从sql/create_time改为sql_text/created_at，状态判断从success改为completed
- 2026-02-28: 增强算子管理功能：新增在线编写Python算子功能（对话框+代码编辑器+模板/示例插入+保存并上传/激活）；更新requirements.txt添加常用数据科学库（numpy/scipy/scikit-learn/statsmodels）
- 2026-02-28: 修复算子上传后列表不显示问题：HandleUploadOperator增加数据库写入逻辑，从文件名解析catelog和name并插入operators表
- 2026-02-28: 修复Python算子无法执行问题：(1)flowsql_web加载libflowsql_bridge.so启动Python Worker；(2)python_process_manager动态设置PYTHONPATH(从可执行文件路径推导)；(3)安装fastapi/uvicorn依赖；(4)修复operator_base.py装饰器bug(attribute方法从@abstractmethod改为默认实现)
- 2026-02-28: 创建测试专家审视报告（docs/test_expert_review.md）：分析架构可测性（7个维度）、测试现状（11%覆盖率）、识别3个P0级缺陷（PluginRegistry无锁/Schema悬空指针/错误处理不一致）、10个高风险测试盲区、提供改进优先级与实施计划
- 2026-02-28: 修复Python算子注册后查询不到的问题：根因是flowsql_framework为静态库，分别链接到主程序和bridge.so导致两个PluginRegistry单例实例；修复方案：将flowsql_framework改为共享库(SHARED)并设置-fvisibility=default导出符号
- 2026-02-28: 代码质量修复（P0+P1+P2共9项）：PluginRegistry加shared_mutex读写锁；Pipeline state_改atomic；ControlServer修复Start竞态/accept EINTR重试/补全消息解析/加cerrno；DataFrame消除const_cast改用mutable；control_client.py修复socket泄漏；arrow_codec.py修复资源泄漏；worker.py修复资源泄漏；清理无用include和死代码
- 2026-02-28: 排查 start_web.sh 启动报错（端口 18900 被占用）：杀掉上次残留的 python3 worker 和 flowsql_web 进程
- 2026-02-28: 分析修复前端页面打不开问题：根因是 PluginRegistry::LoadPlugin() 持有 unique_lock 期间调用 loader_->Load() → StartModules() → BridgePlugin::Start() → WaitWorkerReady()，而 ControlServer 消息线程回调 OnWorkerReady → Register() 也需要 unique_lock，形成死锁；修复：将 StartModules() 从 loader_->Load() 中移除，在 LoadPlugin() 释放锁后单独调用
- 2026-02-28: 修复 Python Worker 孤儿进程问题：flowsql_web 退出时未调用 BridgePlugin::Stop()，Worker 残留占用 18900 端口；修复：main.cpp 退出时调用 UnloadAll()、Init 失败调用 StopModules()；Unload() 中移除 StopModules() 避免同样的死锁；StartModules 加 started_module_count_ 跟踪避免重复启动
- 2026-02-28: 修复前端静态文件 404 + 监听地址安全问题：set_mount_point 相对路径在非 output 目录下找不到 static；修复：基于 /proc/self/exe 定位 static 目录，CMakeLists 加 POST_BUILD 自动复制 web/static 到 output/static，监听地址从 0.0.0.0 改为 127.0.0.1
- 2026-02-28: 实现算子激活后通知 Python Worker 重载：HandleActivateOperator 调用 Worker 的 POST /reload 端点；Worker 重新扫描算子目录，通过控制通道发送 OPERATOR_ADDED 通知 C++ 端动态注册
- 2026-02-28: 审查 Python 端 5 个文件（worker.py/operator_base.py/operator_registry.py/control_client.py/arrow_codec.py）的资源泄漏、线程安全、死代码、逻辑 bug
- 2026-02-28: 代码审查（web_server.h/cpp、main.cpp、database.h/cpp）：分析内存/资源泄漏、死代码、逻辑问题、SQL注入风险
- 2026-02-28: 审查 plugin_registry.h/cpp：内存泄漏（shared_ptr 生命周期）、死代码、锁安全、LoadPlugin/UnloadAll 与 StartModules/StopModules 一致性
- 2026-02-28: 代码审查 bridge 模块 C++ 端（bridge_plugin/python_process_manager/control_server）：分析内存/资源泄漏、文件描述符泄漏、线程生命周期、僵尸进程、双重关闭、死代码等问题
- 2026-02-28: 代码审查修复（17项）：P0修复TCP粘包数据丢失/client_fd_双重关闭竞态/Traverse裸指针悬空/UnloadAll析构顺序；P1修复arrow_codec多batch截断/operator_registry reload/worker.py重载逻辑提取/SQL参数化查询/Database禁拷贝/JSON注入/spawn失败清理/Stop原子化/Unload重置计数器；P2清理占位符注释/未使用import/operators_dir绝对路径/SendMessage短写
- 2026-02-28: 修复算子执行500错误信息丢失问题：IOperator新增LastError()虚方法；PythonOperatorBridge记录详细错误（含Python Worker异常信息）；Pipeline携带error_message；HandleCreateTask返回具体错误；前端catch块提取response.data.error显示
- 2026-02-28: 修复Python算子执行崩溃（basic_string::_M_create）：根因是pd.concat产生null值，C++端ExtractValue未处理null导致对空StringArray调用GetView()崩溃；修复DataFrame::ExtractValue添加IsNull检查返回默认值
- 2026-03-01: 修复Python算子在线创建后未注册到PluginRegistry的4个断裂点：(1)operator_base.py添加clear_registered_operators()清空模块级字典避免已删除算子残留；(2)Operators.vue激活/停用按钮传参从name改为catelog.name匹配后端查询格式；(3)ControlServer MessageLoop改为双层循环支持断线重连；(4)worker.py _do_reload()添加send返回值检查和日志，/reload改用run_in_executor避免阻塞事件循环
- 2026-03-01: 修复Python算子执行500错误：HandleCreateTask核心执行逻辑（Configure+Pipeline::Run+结果读取）添加try-catch，捕获std::exception和未知异常，返回带具体错误信息的JSON 500响应并更新数据库任务状态为failed
- 2026-03-01: 修复basic_string::_M_create崩溃根因：ArrowIpcSerializer::Deserialize使用Buffer::Wrap创建非拥有buffer，反序列化的RecordBatch零拷贝引用httplib响应体内存，响应体销毁后RecordBatch持有悬空指针；修复为AllocateBuffer+memcpy创建拥有所有权的buffer
- 2026-03-01: 排查新算子operator not found问题：根因是用户复制explore_chisquare.py创建新算子时未修改@register_operator装饰器的name参数，三个文件都注册为explore.chisquare导致互相覆盖；修复explore_chi.py和explore_chi2.py的name参数
